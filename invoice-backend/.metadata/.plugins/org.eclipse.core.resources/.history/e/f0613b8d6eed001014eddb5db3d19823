package com.example.invoice_generator.service;

import java.time.LocalDate;

import org.springframework.stereotype.Service;

import com.example.invoice_generator.dto.InvoiceRequest;
import com.example.invoice_generator.model.Invoice;
import com.example.invoice_generator.repository.InvoiceRepository;
import com.example.invoice_generator.util.CalculationUtils;

@Service
public class InvoiceService {
	private final InvoiceRepository invoiceRepository;

	public InvoiceService(InvoiceRepository invoiceRepository) {
		this.invoiceRepository = invoiceRepository;
	}

	public Invoice createInvoice(InvoiceRequest request) {
		Invoice invoice = new Invoice();
		invoice.setInvoiceNumber(generateInvoiceNumber());
		invoice.setInvoiceDate(LocalDate.now());
		invoice.setStatus("DRAFT");

		invoice.setCompanyDetails(request.getCompanyDetails());
		invoice.setCustomerDetails(request.getCustomerDetails());

		List<InvoiceItem> items = request.getItems();
		for (InvoiceItem item : items) {
			BigDecimal lineTotal = CalculationUtils.calculateLineTotal(item.getQuantity(), item.getRate(),
					item.getTaxPercentage());
			item.setLineTotal(lineTotal);
		}

		invoice.setItems(items);
		invoice.setSubTotal(CalculationUtils.calculateSubTotal(items));
		invoice.setGrandTotal(invoice.getSubTotal());

		return invoiceRepository.save(invoice);
	}

	public Invoice getInvoiceById(String id) {
		return invoiceRepository.findById(id)
				.orElseThrow(() -> new RuntimeException("Invoice not found with id: " + id));
	}

	private String generateInvoiceNumber() {
		return "INV-" + UUID.randomUUID().toString().substring(0, 8).toUpperCase();
	}

	public List<Invoice> getAllInvoices() {
		return invoiceRepository.findAll();
	}
}
