package com.example.invoice_generator.service;

import java.io.ByteArrayOutputStream;
import java.math.BigDecimal;
import java.math.RoundingMode;

import org.springframework.stereotype.Service;

import com.example.invoice_generator.model.Invoice;
import com.example.invoice_generator.model.InvoiceItem;
import com.itextpdf.text.*;
import com.itextpdf.text.pdf.*;

@Service
public class PdfGenerationService {
	public byte[] generateInvoicePdf(Invoice invoice) {

		try {
			ByteArrayOutputStream out = new ByteArrayOutputStream();
			Document document = new Document(PageSize.A4, 36, 36, 36, 36);
			PdfWriter.getInstance(document, out);

			document.open();

			Font titleFont = new Font(Font.FontFamily.HELVETICA, 16, Font.BOLD);
			Font boldFont = new Font(Font.FontFamily.HELVETICA, 10, Font.BOLD);
			Font normalFont = new Font(Font.FontFamily.HELVETICA, 10);

			// ===== TITLE =====
			Paragraph title = new Paragraph("INVOICE", titleFont);
			title.setAlignment(Element.ALIGN_CENTER);
			document.add(title);
			document.add(Chunk.NEWLINE);

			// ===== META =====
			document.add(new Paragraph("Invoice No: " + invoice.getInvoiceNumber(), normalFont));
			document.add(new Paragraph("Invoice Date: " + invoice.getInvoiceDate(), normalFont));
			document.add(new Paragraph("Status: " + invoice.getStatus(), normalFont));
			document.add(Chunk.NEWLINE);

			// ===== COMPANY =====
			document.add(new Paragraph("Company Details", boldFont));
			document.add(new Paragraph(invoice.getCompanyDetails().getName(), normalFont));
			document.add(new Paragraph(invoice.getCompanyDetails().getAddress(), normalFont));
			document.add(new Paragraph("GST: " + invoice.getCompanyDetails().getGstNumber(), normalFont));
			document.add(Chunk.NEWLINE);

			// ===== CUSTOMER =====
			document.add(new Paragraph("Customer Details", boldFont));
			document.add(new Paragraph(invoice.getCustomerDetails().getName(), normalFont));
			document.add(new Paragraph(invoice.getCustomerDetails().getCompanyName(), normalFont));
			document.add(new Paragraph(invoice.getCustomerDetails().getAddress(), normalFont));
			document.add(Chunk.NEWLINE);

			// ===== ITEMS TABLE =====
			PdfPTable table = new PdfPTable(6);
			table.setWidthPercentage(100);
			table.setWidths(new float[] { 3, 1, 1.5f, 1, 1.5f, 1.5f });
			table.setSpacingBefore(10);

			addHeader(table, "Description");
			addHeader(table, "Qty");
			addHeader(table, "Rate");
			addHeader(table, "Tax %");
			addHeader(table, "Tax Amt");
			addHeader(table, "Total");

			BigDecimal subTotal = BigDecimal.ZERO;
			BigDecimal taxTotal = BigDecimal.ZERO;

			for (InvoiceItem item : invoice.getItems()) {
				// âœ… Null-safe numeric values
				BigDecimal qty = item.getQuantity() != null ? item.getQuantity() : BigDecimal.ZERO;
				BigDecimal rate = item.getRate() != null ? item.getRate() : BigDecimal.ZERO;
				BigDecimal taxPercent = item.getTaxPercentage() != null ? item.getTaxPercentage() : BigDecimal.ZERO;

				BigDecimal lineAmount = rate.multiply(qty);
				BigDecimal taxAmount = lineAmount.multiply(taxPercent).divide(BigDecimal.valueOf(100), 2,
						RoundingMode.HALF_UP);
				BigDecimal lineTotal = lineAmount.add(taxAmount);

				subTotal = subTotal.add(lineAmount);
				taxTotal = taxTotal.add(taxAmount);

				table.addCell(textCell(item.getDescription() != null ? item.getDescription() : "", normalFont,
						Element.ALIGN_LEFT));
				table.addCell(textCell(qty.toString(), normalFont, Element.ALIGN_CENTER));
				table.addCell(textCell(rate.toString(), normalFont, Element.ALIGN_RIGHT));
				table.addCell(textCell(taxPercent.toString(), normalFont, Element.ALIGN_CENTER));
				table.addCell(textCell(taxAmount.toString(), normalFont, Element.ALIGN_RIGHT));
				table.addCell(textCell(lineTotal.toString(), normalFont, Element.ALIGN_RIGHT));
			}

			document.add(table);
			document.add(Chunk.NEWLINE);

			// ===== TOTALS =====
			PdfPTable totals = new PdfPTable(2);
			totals.setWidthPercentage(40);
			totals.setHorizontalAlignment(Element.ALIGN_RIGHT);
			totals.setWidths(new float[] { 2, 1 });

			totals.addCell(labelCell("Subtotal", boldFont));
			totals.addCell(valueCell(subTotal));

			totals.addCell(labelCell("Tax Total", boldFont));
			totals.addCell(valueCell(taxTotal));

			totals.addCell(labelCell("Grand Total", boldFont));
			totals.addCell(valueCell(subTotal.add(taxTotal)));

			document.add(totals);

			document.close();
			return out.toByteArray();

		} catch (Exception e) {
			throw new RuntimeException("PDF generation failed", e);
		}
	}

	// ===== HELPERS =====
	private void addHeader(PdfPTable table, String text) {
		Font font = new Font(Font.FontFamily.HELVETICA, 10, Font.BOLD);
		PdfPCell cell = new PdfPCell(new Phrase(text, font));
		cell.setHorizontalAlignment(Element.ALIGN_CENTER);
		cell.setBackgroundColor(BaseColor.LIGHT_GRAY);
		cell.setPadding(6);
		table.addCell(cell);
	}

	private PdfPCell textCell(String text, Font font, int align) {
		PdfPCell cell = new PdfPCell(new Phrase(text, font));
		cell.setHorizontalAlignment(align);
		cell.setPadding(6);
		return cell;
	}

	private PdfPCell labelCell(String text, Font font) {
		PdfPCell cell = new PdfPCell(new Phrase(text, font));
		cell.setBorder(Rectangle.NO_BORDER);
		return cell;
	}

	private PdfPCell valueCell(BigDecimal value) {
		PdfPCell cell = new PdfPCell(new Phrase(value.toString()));
		cell.setHorizontalAlignment(Element.ALIGN_RIGHT);
		cell.setBorder(Rectangle.NO_BORDER);
		return cell;
	}
}
